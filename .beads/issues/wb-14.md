---
id: wb-14
title: "WebSocket (wss://) forbindelse fejler i produktion"
type: bug
status: open
priority: 2
created: 2026-02-11
---

# WebSocket (wss://) forbindelse fejler i produktion

Real-time collaboration via WebSocket virker ikke på det deployede site. Forbindelsen fejler gentagne gange med reconnect-forsøg.

## Reproducer

1. Log ind og åbn et board
2. Tjek browser-konsollen

## Forventet

WebSocket-forbindelse til wss://whiteboard.udstillerguide.dk/ws/{board_id} oprettes succesfuldt.

## Faktisk

WebSocket-forbindelsen fejler. Klienten forsøger at reconnecte med eksponentiel backoff (1s, 2s, 4s, 8s, 16s...) men fejler hver gang.

## Konsekvens

- Ingen real-time samarbejde mellem brugere
- Ændringer synkroniseres ikke

## Mulig årsag

Reverse proxy (nginx/Caddy) er muligvis ikke konfigureret til at upgrade HTTP-forbindelser til WebSocket. Kræver typisk:

```nginx
# Nginx eksempel
location /ws/ {
    proxy_pass http://backend:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

## Konsol-fejl

```
WebSocket connection to 'wss://whiteboard.udstillerguide.dk/ws/{id}?token=...' failed
WebSocket error: Event
WebSocket disconnected
Reconnecting in 1000ms (attempt 1)
...
```

## Investigation (2026-02-11)

**Diagnosis: Reverse proxy issue - NOT a code bug**

### Backend code verified correct

- Route defined at `main.rs:107`: `.route("/ws/{board_id}", get(ws::handler::ws_handler))`
- Handler at `ws/handler.rs:32`: uses `WebSocketUpgrade` extractor correctly
- Auth via query params: `?token=` (JWT) or `?share_token=` (guest access)
- Socket handler at `ws/handler.rs:64`: properly manages Yrs doc sync, room management, broadcast
- Periodic state persistence to PostgreSQL every 100 updates + on room close

### Root cause

WebSocket connections require the reverse proxy to:
1. Forward the `Upgrade` and `Connection` HTTP headers
2. Use HTTP/1.1 for the proxied connection (HTTP/2 handles WS differently)
3. NOT buffer the connection
4. Have appropriate read timeouts (default nginx timeout of 60s will drop idle WS connections)

Without this, the TLS-terminating proxy blocks the HTTP→WebSocket upgrade handshake.

### Recommended reverse proxy configuration

All three bugs (wb-12, wb-13, wb-14) are caused by incorrect reverse proxy configuration. The simplest fix:

#### Caddy (recommended - simplest)

```
whiteboard.udstillerguide.dk {
    reverse_proxy app:3000
}
```

Caddy's `reverse_proxy` automatically:
- Forwards ALL HTTP methods (fixes wb-12)
- Matches all sub-paths (fixes wb-13)
- Handles WebSocket upgrade transparently (fixes wb-14)
- Manages TLS certificates via Let's Encrypt

#### Nginx (if used instead)

```nginx
server {
    listen 443 ssl http2;
    server_name whiteboard.udstillerguide.dk;

    # TLS certs...

    # Catch-all: proxy everything to the backend
    location / {
        proxy_pass http://app:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (fixes wb-14)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
}
```

Key points:
- `location /` matches ALL paths including `/api/boards/{uuid}` (fixes wb-13)
- No method restrictions (fixes wb-12)
- `proxy_set_header Upgrade/Connection` enables WebSocket (fixes wb-14)
- `proxy_read_timeout 86400` prevents nginx from closing idle WebSocket connections
